#!/bin/bash

for SAMPLE in $*; do
    [ -d $SAMPLE ] || continue
    echo "=== Retrieving ${SAMPLE} ==="
    [ -d $SAMPLE/unmerged ] || mkdir -p $SAMPLE/unmerged
    FILES=$(grep "newPfn = .*\.root" ${SAMPLE}/res/CMSSW_*.stdout | awk '{print $4}')
    NFILES=$(echo $FILES | wc -w)
    IFILE=0
    for FILE in $FILES; do
        FILENAME=$(basename $FILE)
        IFILE=$(($IFILE+1))
        JOBID=$(echo $FILENAME | awk -F_ '{print $2}')
        if [ -f $SAMPLE/unmerged/$FILENAME ]; then
            REMOTE=$(grep -m1 "^-rw.*${FILENAME}" ${SAMPLE}/res/CMSSW_${JOBID}.stdout | awk '{print $5" "$9}')
            LOCAL=$(ls -l $SAMPLE/unmerged/$FILENAME | awk '{print $5" "$9}')
            REMOTESIZE=$(echo $REMOTE | awk '{print $1}')
            LOCALSIZE=$(echo $LOCAL | awk '{print $1}')
            [ $REMOTESIZE == $LOCALSIZE ] && continue
            echo "File already exists."
            echo "    remote : $REMOTE"
            echo "    local  : $LOCAL"
            echo -n "Remove and get once again? [Y/N]"
            read YN
            if [ "_$YN" != _y -a "_$YN" != _Y ]; then
                continue
            fi
        fi
        echo -ne "Downloading $FILE (${IFILE}/${NFILES})\r"
        lcg-cp $FILE $SAMPLE/unmerged/$FILENAME
    done

    echo "=== Merging ${SAMPLE} ==="
    hadd -f $SAMPLE/$SAMPLE.root $SAMPLE/unmerged/fakeTree*.root
done
